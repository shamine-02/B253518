---
title: "Is there a correlation between presriptions of Salbutamol and proportions of households without central heating in healthboards in Scotland?"
output: html_document
date: "2025-10-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

## Introduction

This question aims to determine whether there is a correlation between the number of prescriptions for salbutamol inhalers (including branded salbutamol inhalers) and the proportion of households without central heating in NHS Scotland healthboards.

Salbutamol inhalers are used to relieve the symptoms of respiratory conditons, such as asthma and chronic obstructive pulmonary disease. Patients may use their salbutamol inhaler when they experience symptoms, such as breathlessness, tightness in their chest, coughing and wheezing. These symptoms are usually exacerbated by the cold weather. Therefore, this questions aims to determine if there is a difference between prescriptions for salbutamol inhalers in areas with higher proportions of households with no central heating.We will look at the months which are the coldest in Scotland, the winter months, which for 2021/2022 were December, January and February.


```{r message=FALSE}
pacman::p_load(tidyverse, janitor, here, readxl, magrittr)
```

```{r}
#load data for central heating
heating_data2022 <- read_excel(here("data", "table_2025-11-12_19-17-58.xlsx"))

#tidy dataset and change values in hb_area column to include NHS + healthboard name
tidy_heating2022 <- heating_data2022 %>% 
  rename(c("hb_area2019" = ...2,
           "occupied_households" = ...3,
           "no_central_heating" = ...4)) %>% 
  select(c(hb_area2019:no_central_heating)) %>%
  mutate(hb_area2019 = paste("NHS", hb_area2019)) %>% #add NHs to name of healthboard
  filter(!row_number() %in% c(1:9, 24:28)) #remove, since rows contain no data

#change data for no_central_heating and occupied_households into integers (from characters) and add a column that shows the proportion of households without central heating
tidy_heating2022 %<>% mutate(no_central_heating = as.numeric(no_central_heating),
         occupied_households = as.numeric(occupied_households)) %>% 
    mutate(percent_no_heating = (no_central_heating/occupied_households)*100)#add column percent_no_heating 
  
```

To find the dataset for census data regarding central heating, go to: <https://www.scotlandscensus.gov.uk/webapi/jsf/tableView/tableView.xhtml>

```{r loading datasets}
#function to clean datasets
clean_prescriptions <- function(df){
  df %>% 
    drop_na() %>%
    clean_names()
  }

data_dec2021 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/ad9e7b46-47fb-4d42-baad-f8e98e8f5936/download/pitc202112.csv") %>%
  clean2122()

data_jan2022 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/53a53d61-3b3b-4a12-888b-a788ce13db9c/download/pitc202201.csv") %>%
  clean2122

data_feb2022 <- read_csv("https://www.opendata.nhs.scot/dataset/84393984-14e9-4b0d-a797-b288db64d088/resource/bd7aa5c9-d708-4d0b-9b28-a9d822c84e34/download/pitc202202.csv") %>%
  clean2122

# links <- read_csv(here("file_links.csv")) %>% 
#   select(link) %>% 
#   pull
```


```{r}
#function to filter for salbutamol inhalers and summarise inhaler prescriptions
salbut_relievers <- c("SALBUTAMOL", "VENTOLIN", "AIROMIR", "ASMALAL", "EASYHALER", "PULVINAL", "SALAMOL", "EASI-BREATHE", "SALBULIN") #names of salbutamol and brand equivalents

salbut_presc <- function(df){
  df %>% 
  filter(str_detect(bnf_item_description,
                    paste(salbut_relievers, collapse = "|"))) %>% 
  filter(!(str_detect(bnf_item_description,
                      "FORMOTEROL|BECLOMET|BUDESONIDE|FOBUMIX"))) %>% 
  select(c(hbt, bnf_item_description, paid_quantity)) %>% #prepare dataset
  group_by(hbt) %>% 
  summarise(prescribed_salbutamol = sum(paid_quantity)) %>% #add new column for sum
  subset(hbt != "SB0806") #removing row with code SB0806
}

#filtering datasets for each winter month in 2021/2022 and 2015/2016

salbut_dec2021 <- salbut_presc(data_dec2021) %>% 
  rename("salbutamol_dec21" = prescribed_salbutamol)

salbut_jan2022 <- salbut_presc(data_jan2022) %>% 
  rename("salbutamol_jan22" = prescribed_salbutamol)

salbut_feb2022 <- salbut_presc(data_feb2022) %>% 
  rename("salbutamol_feb22" = prescribed_salbutamol)
```

code for Scottish Ambulance service: https://www.opendata.nhs.scot/dataset/non-standard-geography-codes-and-labels/resource/0450a5a2-f600-4569-a9ae-5d6317141899 

```{r}
#join datasets for 2015/2016 and 2021/2022 together
join_prescription <- function(df1, df2){
  df1 %>% 
    full_join(df2, join_by("hbt" == "hbt"))
}
#join winter 2021/2022 data together
joined_salbut_2122 <- join_prescription(salbut_dec2021, salbut_jan2022)

joined_salbut_2122 <- join_prescription(joined_salbut_2122, salbut_feb2022)
```

```{r}
#join with hb names
HB_names <- read_csv("https://www.opendata.nhs.scot/dataset/9f942fdb-e59e-44f5-b534-d6e17229cc7b/resource/652ff726-e676-4a20-abda-435b98dd7bdc/download/hb14_hb19.csv") %>% 
  clean_names()

hb_salbut_2122 <- joined_salbut_2122 %>% 
  full_join(HB_names, join_by("hbt" == "hb")) %>% 
  select(c(hbt, hb_name, starts_with("salbutamol"))) %>% 
  filter(!is.na(salbutamol_dec21)) #rows contain old area codes (now archived)
```
Area codes from row 15 to 18 are the old area codes from the 2014 healthboard boundaries, but which were changed in 2019.
***find link***

```{r}
#join population data
population_data <- read_csv("https://www.opendata.nhs.scot/dataset/7f010430-6ce1-4813-b25c-f7f335bdc4dc/resource/27a72cc8-d6d8-430c-8b4f-3109a9ceadb1/download/hb2019_pop_est_03102025.csv")

population_2122 <- population_data %>% 
  filter(Year == "2022"& Sex == "All") %>% 
  select(c(HB, AllAges))

#join prescription data and population data
joint_data <- salbut_1516 %>% 
  full_join(population_1516, join_by("hbt" == "HB")) %>% 
  
```

```{r}
#join asthma_data_12_21 and heating data (2022)

joined_dec2021 <- asthma_meds_12_21 %>% 
  full_join(heating_data2022, by = (c("hb_name" = "hb_area2019")))

#plotting data for % of households with heating in a healthboard and prescriptions of salbutamol

joined_dec2021 %>% 
  ggplot(aes(x = percent_no_heating, y = prescribed_salbutamol, colour = hb_name))+
  geom_point() +
  labs( title = "Plot showing the number of prescription against % of houeholds without heating",
        subtitle = "Decemebr 2021",
        x = "no central heating (%)",
        y = "number of salbutamol prescribed")

```

## Including Plots

```{r echo=FALSE}
heating_data2011 <- read_excel(here("data", "table_2025-11-12_20-16-59.xlsx"))
```

Reference List

<https://www.nhs.uk/medicines/salbutamol-inhaler/about-salbutamol-inhalers/>

<https://www.nhs.uk/conditions/chronic-obstructive-pulmonary-disease-copd/>

<https://www.asthmaandlung.org.uk/living-with/cold-weather>
